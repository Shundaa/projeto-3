<html>

<head>
<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="Cliente.js"></script>
<script>

function registerTOJSON(){
    var result = {
    "nome" : $('#txtAnfitriao').val()
}
return (JSON.stringify(result));
};

function formToJSON() {
    var result = {
        "id" : $('#compromissoId').val(),
        "anfitriao" : $('#txtAnfitriao').val(),
        "nomeEvento" : $('#txtnomeEvento').val(),
        "dataEvento" : $('#txtdataEvento').val(),
        "horarioEvento" : $('#txthorarioEvento').val(),
        "convidados" : [],
        "alertas" : []
    };

    $("#convidados span").each(function(index, elem) {

        result.convidados.push({
            "nome" : $("#convidados #" + elem.id + " input:eq(0)").val()
        });

    });
    
    return (JSON.stringify(result));
    $("#alert  span").each(function(index, elem) {

        result.convidados.push({
        "nome" : $("#alert #" + elem.id + " input:eq(0)").val(),
        "horaAlerta" : $("#alert #" + elem.id + " input:eq(1)").val()
        });

    });



return (JSON.stringify(result));
}

function loadCompromisso(id) {
    findById(id, function(data) {
        fillForm(data);
        $("#form").css({
            "visibility" : "visible",
            "display" : "block"
        });
        $("#fieldset").html(" Editando Compromisso ");
    });
}

function loadCompromissoNome(user) {
    findByName(user, function(data) {
        fillForm(data);
        $("#formRecebendo").css({
            "visibility" : "visible",
            "display" : "block"
        });
        $("#fieldset").html(" Editando Compromisso ");
    });
}

function clearForm() {
    $("#fieldset").html("");
    fillForm({
        "name" : ""
    });
}

function fillForm(compromisso) {

    $("#compromissoId").val(compromisso.id);

    $("#txtAnfitriao").val(compromisso.anfitriao);

    $("#txtnomeEvento").val(compromisso.nomeEvento);

    $("#txtdataEvento").val(compromisso.dataEvento);
    
    $("#horarioEvento").val(compromisso.horarioEvento);

    $("#convidados").html("");
    if (compromisso.convidados != null) {
        for ( var i = 0; i < compromisso.convidados.length; i++) {
            addConvidado("#convidados", compromisso.convidados[i].nome );
        }
    }

    $("#alertas").html("");
    if (compromisso.alertas != null) {
        for ( var i = 0; i < convidados.alertas.length; i++) {
            addInput("#Alertas", compromisso.alertas[i].nome,
                    compromisso.alertas[i].horaAlerta);
        }
    }
}

function addConvidado(root, nome) {
    var index = $(root).children().length;
    var html = "<span id='item" + index + "' ><input type='text' value='"
            + nome + "'>";
     html += "<input type='button' value='-' onclick='$(\"" + root + " #item"
            + index + "\").remove()'><br/></span>";

    inputs = $(root).append(html);
}
function addAlert(root, nome, date) {
    var index = $(root).children().length;
    var html = "<span id='item" + index + "' ><input type='text' value='"
            + type + "'>";
    html += "<input type='text' value='" + value + "'>";
    html += "<input type='button' value='-' onclick='$(\"" + root + " #item"
            + index + "\").remove()'><br/></span>";

    inputs = $(root).append(html);
}


function saveOrUpdate() {
    if ($("#compromissoId").val() != null && $("#compromissoId").val() != "") {
        updateCompromissot($('#compromisso').val(), formToJSON(), function(data, textStatus, jqXHR) {
            alert('Compromisso atualizado com sucesso!');
            clearForm();
            $("#formCompromisso").css({
                "visibility" : "hidden",
                "display" : "none"
            });
            findAll();
        });
    } else {
        addCompromisso(formToJSON(), function(data, textStatus, jqXHR) {
            alert('Compromisso criado com sucesso!');
            clearForm();
            $("#formCompromisso").css({
                "visibility" : "hidden",
                "display" : "none"
            });
            findAll(renderList);
        });
    }
}
function AlertsaveOrUpdate() {
    if ($("#compromissoId").val() != null && $("#compromissoId").val() != "") {
        addAlerta($('#compromisso').val(), formToJSON(), function(data, textStatus, jqXHR) {
            alert('Alerta adicionado com sucesso!');
            clearForm();
            $("#formAlerta").css({
                "visibility" : "hidden",
                "display" : "none"
            });
            findAll();
        });
    } else {
            alert('Compromisso inexistente!');
            
        };
    }

function registerSaveOrUpdate() {
    if ($("#userId").val() != null && $("#userId").val() != "") {
        updateUser($('#UserId').val(), registerTOJSON(), function(data, textStatus, jqXHR) {
            alert('Usuario atualizado com sucesso!');
            clearForm();
            $("#formRegistro").css({
                "visibility" : "hidden",
                "display" : "none"
            });
            findAll();
        });
    } else {
        addUser(registerTOJSON(), function(data, textStatus, jqXHR) {
            alert('Usuario criado com sucesso!');
            clearForm();
            $("#formRegistro").css({
                "visibility" : "hidden",
                "display" : "none"
            });
            findAll(renderList);
        });
    }
}

function newCompromisso() {
    clearForm();
    $("#formCompromisso").css({
        "visibility" : "visible",
        "display" : "block"
    });
    $("#fieldset").html("Novo Compromisso");
}
function cancelCompromisso() {

$("#formCompromisso").css({
    "visibility" : "hidden",
    "display" : "none"
});
clearForm();
}
function newUsuario() {
    clearForm();
    $("#formRegistro").css({
        "visibility" : "visible",
        "display" : "block"
    });
    $("#fieldset").html(" Novo Usuario");
}
function cancelUsuario() {

$("#formRegistro").css({
    "visibility" : "hidden",
    "display" : "none"
});
clearForm();
}

function searchDate() {
    findByDate($("#searchDate").val(), renderList);
}

function removeCompromisso(id) {
    deleteCompromisso(id, function(data, textStatus, jqXHR) {
        alert('Compromisso removido com sucesso!');
        findAll(renderList);
    });
}



function renderList(data) {

    var html = "";

    html += "<ul>";

    for ( var i = 0; i < data.length; i++) {
        var compromisso = data[i];

        html += "<li><strong>"
                + compromisso.nomeEvento + " | " + compromisso.anfitriao + " | " + compromisso.dataEvento + ' | ' + compromisso.horarioEvento
                + "</strong>";

        if (compromisso.convidados != null && compromisso.convidados.length > 0) {
            html += " | " + compromisso.convidados[0].nome + " | ";
        }

        if (compromisso.alertas != null && compromisso.alertas.length > 0) {
            html += " | " + compromisso.alertas[0].nome + " | ";
                    + compromisso.alertas[0].data + " | ";
        }

        html += "</li>";

    }

    html += "</ul>";

    $("#result").html(html);
}

$(function() {
    
    findAll(renderList);

    $("#search").keyup(function(event) {
        if (event.keyCode == 13) {
            $("#btnSearch").click();
        }
    });

});

function renderDateList(data) {

var html = "";

html += "<ul>";

for ( var i = 0; i < data.length; i++) {
    var compromisso = data[i];

    html += "<li><strong>"
            + compromisso.nomeEvento + " | " + compromisso.anfitriao + " | " + compromisso.dataEvento + ' | ' + compromisso.horarioEvento
            + "</strong>";

    if (compromisso.convidados != null && compromisso.convidados.length > 0) {
        html += " | " + compromisso.convidados[0].nome + " | ";
    }

    if (compromisso.alertas != null && compromisso.alertas.length > 0) {
        html += " | " + compromisso.alertas[0].nome + " | ";
                + compromisso.alertas[0].data + " | ";
    }

    html += "<input type='button' value='-' title='Apagar este Compromisso' onclick='removeCompromisso("
            + compromisso.id + ")'>";

    html += "</li>";

}

html += "</ul>";

$("#resultData").html(html);
}
$(function() {  
    findByDate($("#searchDate").val(), renderDateList);
        if (event.keyCode == 13) {
            $("#btnSearch").click();
        }

});




</script>
</head>
<body>

    <h1>Usuarios</h1>
    <hr />
    <div id="result"></div>

    <input type="button" value="Registrar" onclick="newUsuario();">

    <br />
    <br />

    <div id="formRegistro" style="visibility: hidden; display: none;">

        <form>
            <fieldset>
                <legend id="fieldset"></legend>
                <input id="UserId" type="hidden"> <label
                    for="txtAnfitriao">Nome: </label> <input id="txtAnfitriao"
                    type="text" name="nome" /><br /> 
                <br /> <input id="btnSave" type="button" value="Salvar"
                    onclick="registerSaveOrUpdate();"> <input
                    id="btnCancel" type="reset" value="Cancelar"
                    onclick="cancelUsuario();">

            </fieldset>
        </form>
    </div>


</body>

<body>

    <h1>Compromissos</h1>
    <hr />

    <div id="actions">

        <fieldset>
            <legend>Buscar Compromisso</legend>
            <label>Data Compromisso</label> <input type="text" id="searchDate">
            <input type="button" id="btnSearch" value="Buscar"
                onclick="searchDate();">
        </fieldset>

    </div>

    <div id="resulData"></div>

    <input type="button" value="Novo Compromisso" onclick="newCompromisso();">

    <br />
    <br />

    <div id="formCompromisso" style="visibility: hidden; display: none;">

        <form>
            <fieldset>
                <legend id="fieldset">Cadastrar Compromisso</legend>
                <input id="compromissoId" type="hidden"> <label
                    for="txtnomeEvento">Nome Compromisso: </label> <input id="txtnomeEvento"
                    type="text" name="nomeEvento" /><br /> 
                    <label
                    for="txtdataEvento">Data Compromisso: </label> <input id="txtdataEvento"
                    type="text" name="dataEvento" />
                    <label
                    for="txthorarioEvento">Hora Compromisso: </label> <input id="txthorarioEvento"
                    type="text" name="horarioEvento" />
                    <br />Convidados: <input
                    type="button" value="+"
                    onclick="addConvidado('#convidados','')">
                <div id="convidados"></div>
             <input id="btnSave" type="button" value="Salvar"
                    onclick="saveOrUpdate();"> <input
                    id="btnCancel" type="reset" value="Cancelar"
                    onclick="cancelCompromisso();">

            </fieldset>
        </form>
    </div>
    

</body>

</html>

<body>
    <div id="alertas">
        <div id="Aceitar Compromisso">
        <fieldset>
            <legend>Aceitar Convite Compromisso</legend>

        </fieldset>
        <div id="formAlerta" style="visibility: hidden; display: none;">

            <form>
                <fieldset>
                    <legend id="fieldset">Cadastrar Alerta</legend>
                    <input id="compromissoId" type="hidden"> <label
                        for="txtnomeEvento">Nome Compromisso: </label> <input id="txtnomeEvento"
                        type="text" name="name" /><br /> 
                        <label
                        for="txtdataEvento">Data Alerta </label> <input id="txtdataEvento"
                        type="text" name="dataEvento" /><br />
                 <input id="btnSave" type="button" value="Salvar"
                        onclick="saveOrUpdate();"> <input
                        id="btnCancel" type="reset" value="Cancelar"
                        onclick="cancelCompromisso();">
    
                </fieldset>
            </form>
        </div>
        </div>
        <div id="Alerta">
            <fieldset>
                <script>
                while(true){
                    if(typeof(EventSource) !== "undefined") {
                    var source = new EventSource("http://localhost:8080/sse/user?nome="+user);
                    source.onmessage = function(event) {
                      document.getElementById("result").innerHTML += event.data + "<br>";
                    };
                  } else {
                    document.getElementById("result").innerHTML = "Sorry, your browser does not support server-sent events...";
                  }
                }
                  </script>>
                        </fieldset>
                    </form>
                </div>
            </fieldset>

        </div>
    </div>
    

    </div>

</body>

</html>
